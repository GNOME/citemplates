# This file should only be used if the build fails to to requiring an SDK
# extension. Use `flatpak_ci_initiative.yml` for everything else.
.flatpak:
  image: 'registry.gitlab.gnome.org/gnome/gnome-runtime-images/gnome:master'
  stage: '.pre'
  tags:
    - flatpak
  script:
    - flatpak-builder --user --disable-rofiles-fuse --stop-at=${FLATPAK_MODULE} flatpak_app ${MANIFEST_PATH}
    # Make sure to keep this in sync with the Flatpak manifest, all arguments
    # are passed except the config-args because we build it ourselves
    - flatpak-builder --run --disable-rofiles-fuse flatpak_app ${MANIFEST_PATH} meson --prefix=/app ${MESON_ARGS} _build
    - flatpak-builder --run --disable-rofiles-fuse flatpak_app ${MANIFEST_PATH} ninja -C _build install
    - flatpak-builder --disable-rofiles-fuse --finish-only --repo=repo ${BRANCH:+--default-branch=$BRANCH} flatpak_app ${MANIFEST_PATH}
    # Run automatic tests inside the Flatpak env
    - >
      xvfb-run -a -s "-screen 0 1024x768x24"
      flatpak-builder --run --disable-rofiles-fuse
      --env=LANG=C.UTF-8
      --env=NO_AT_BRIDGE=1
      ${TEST_BUILD_ARGS}
      flatpak_app
      ${MANIFEST_PATH}
      dbus-run-session
      meson test -C _build --no-stdsplit --print-errorlogs ${TEST_RUN_ARGS}

    # Generate a Flatpak bundle
    - flatpak build-bundle repo ${BUNDLE} --runtime-repo=${RUNTIME_REPO} ${APP_ID} ${BRANCH}
    - tar cf repo.tar repo/
  artifacts:
    name: 'Flatpak artifacts'
    expose_as: 'Get Flatpak bundle here'
    when: 'always'
    paths:
      - "${BUNDLE}"
      - 'repo.tar'
      - '_build/meson-logs/meson-log.txt'
      - '_build/meson-logs/testlog.txt'
    expire_in: 14 days
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - '.flatpak-builder/downloads'
      - '.flatpak-builder/git'

.review:
  stage: '.post'
  script:
    - echo "This job has been deprecated and is no longer needed!"
  except:
    refs:
      - 'tags'
      - 'master'
      - 'branches'

.stop_review:
  stage: '.post'
  script:
    - echo "This job has been deprecated and is no longer needed!"
  except:
    refs:
      - 'tags'
      - 'master'
      - 'branches'

.publish_nightly:
  image: 'registry.gitlab.gnome.org/gnome/gnome-runtime-images/flat-manager-client'
  stage: '.post'
  script:
    - tar xf repo.tar
    - BUILD_ID=$(flat-manager-client create ${FLAT_MANAGER_URL} ${FLATPAK_REPO})
    - flat-manager-client push --commit --publish --wait ${BUILD_ID} repo/ || result=$?
    - flat-manager-client purge ${BUILD_ID}
    - exit $result
  variables:
    FLAT_MANAGER_URL: https://nightly.gnome.org/
    FLATPAK_REPO: nightly
  only:
    refs:
      - master
    variables:
      - $REPO_TOKEN
