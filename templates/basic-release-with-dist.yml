spec:
  inputs:
    job-name:
      default: "release_job"
      description: "Name for the job"
    job-stage:
      default: "deploy"
      description: "Stage to run the job"
    dist-job-name:
      description: "The name of the job that produced the dist tarball in your pipeline"
---
variables:
  INPUT_TARBALL_ARTIFACT_PATH: $[[ inputs.tarball-artifact-path ]]

"$[[ inputs.job-name ]]":
  stage: $[[ inputs.job-stage ]]
  image: "registry.gitlab.com/gitlab-org/cli:latest"
  needs:
    - job: $[[ inputs.dist-job-name ]]
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  before_script: []
  after_script: []
  script:
    # https://gitlab.com/gitlab-org/gitlab/-/issues/382536
    - echo "Fixing up release tag message for gitlab"
    - a=$(git tag -l $CI_COMMIT_TAG --format='%(contents)')
    - tag_msg=$(printf '%s\n' "${a%%-----BEGIN*}")

    - echo "running release_job"
    - glab auth login --hostname $CI_SERVER_HOST --job-token $CI_JOB_TOKEN
    - glab release create "$CI_COMMIT_TAG" --notes $tag_msg --tag-message $tag_msg

    - glab release upload "$CI_COMMIT_TAG" $INPUT_TARBALL_ARTIFACT_PATH $INPUT_TARBALL_ARTIFACT_PATH.sha256sum
