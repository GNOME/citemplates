spec:
  inputs:
    job-name:
      default: "release_job"
      description: "Name for the job"
    job-stage:
      default: "deploy"
      description: "Stage to run the job"
    dist-job-name:
      description: "The name of the job that produced the dist tarball in your pipeline"
    tarball-artifact-path:
      description: "The path of the exported tarball"

---
variables:
  # TODO are the version and project name correct?
  # See https://docs.gitlab.com/user/packages/generic_packages/
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${CI_COMMIT_TAG}"
  INPUT_TARBALL_ARTIFACT_PATH: $[[ inputs.tarball-artifact-path ]]

"$[[ inputs.job-name ]]":
  stage: $[[ inputs.job-stage ]]
  image: "registry.gitlab.com/gitlab-org/release-cli:latest"
  needs:
    - job: $[[ inputs.dist-job-name ]]
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  before_script: []
  after_script: []
  script:
    - apk add --no-cache curl
    - tarball=$(basename $INPUT_TARBALL_ARTIFACT_PATH)
    - echo "running release_job"
    - echo "uploading ${tarball}"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $[[ inputs.tarball-artifact-path ]] ${PACKAGE_REGISTRY_URL}/${tarball}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $[[ inputs.tarball-artifact-path ]].sha256sum ${PACKAGE_REGISTRY_URL}/${tarball}.sha256sum
    # https://gitlab.com/gitlab-org/gitlab/-/issues/382536
    - echo "Fixing up release tag message for gitlab"
    - a=$(git tag -l $CI_COMMIT_TAG --format='%(contents)')
    - tag_msg=$(printf '%s\n' "${a%%-----BEGIN*}")
    - |
      release-cli create \
      --tag-name $CI_COMMIT_TAG \
      --description $tag_msg \
      --assets-link "{\"name\":\"${tarball}\",\"url\":\"${PACKAGE_REGISTRY_URL}/${tarball}\",\"direct_asset_path\":\"/${tarball}\"}" \
      --assets-link "{\"name\":\"${tarball}.sha256sum\",\"url\":\"${PACKAGE_REGISTRY_URL}/${tarball}.sha256sum\",\"direct_asset_path\":\"/${tarball}.sha256sum\"}"
