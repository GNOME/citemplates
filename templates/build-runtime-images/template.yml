spec:
  inputs:
    platform-version:
      description: "Version of the GNOME Platform to install"
    fdsdk-version:
      description: "Version of the FDSDK base"
    llvm-version-1:
      description: "Version of the .Extension.llvm to install"
    llvm-version-2:
      description: "Version of the .Extension.llvm to install"
---
#
# THIS IS A TEMPLATE FOR PRIVATE USE WITHIN THIS REPOSITORY
#

".common:$[[ inputs.platform-version ]]":
  image: "quay.io/buildah/stable:latest"
  # Buildah can't use 'overlay' driver when running inside docker
  variables:
    STORAGE_DRIVER: "vfs"
    BUILDAH_FORMAT: "docker"
    BUILDAH_ISOLATION: "chroot"
  rules:
    - if: $CI_MERGE_REQUEST_ID && "$[[ inputs.platform-version ]]" == "master"
      when: "always"
    - if: $REBUILD_STABLE && "$[[ inputs.platform-version ]]" != "master"
      when: "always"
    - if: $CI_COMMIT_BRANCH == "master"
      when: "always"
    - if: $CI_COMMIT_BRANCH
      when: "manual"

".sdk_template:$[[ inputs.platform-version ]]":
  stage: "gnome-runtime-images"
  extends: ".common:$[[ inputs.platform-version ]]"
  needs: ["base-manifest"]
  after_script: []
  script:
    - bash ./gnome-runtime-images/scripts/build-sdk-image.sh "$[[ inputs.platform-version ]]" "$[[ inputs.fdsdk-version ]]" "$[[ inputs.llvm-version-1 ]]" "$[[ inputs.llvm-version-2 ]]"

"gnome:$[[ inputs.platform-version ]]":
  extends: ".sdk_template:$[[ inputs.platform-version ]]"
  variables:
    ARCH: x86_64

"gnome:aarch64:$[[ inputs.platform-version ]]":
  extends: ".sdk_template:$[[ inputs.platform-version ]]"
  tags:
    - aarch64
    - gnome-build-meta
  variables:
    ARCH: aarch64

"gnome-manifest:$[[ inputs.platform-version ]]":
  stage: "gnome-runtime-images"
  extends: ".common:$[[ inputs.platform-version ]]"
  after_script: []
  needs:
    - job: "gnome:$[[ inputs.platform-version ]]"
      artifacts: false
    - job: "gnome:aarch64:$[[ inputs.platform-version ]]"
      artifacts: false
  script:
    - bash ./gnome-runtime-images/scripts/make-manifest.sh "gnome-$[[ inputs.platform-version ]]"
